<table width="100%">
  <% form_for :donation, @donation, :url => {:action => 'done', :donation_id => @donation.id} do |f| -%>
    <%= f.error_messages %>
    <tr>
        <td align="right">Notify
        </td>
        <td align="left"><%= @donation.notification_email %>
        </td>
    </tr>
   <% @donation.donation_line_items.each_with_index do |dli, index| -%>
    <tr>
        <td align="right"><%= dli.description %>
        </td>
        <td align="left"><%= dli.amount.format(:html) %>
        </td>
    </tr>
  <% end -%>
    <tr>
        <td align="right">total
        </td>
        <td align="left"><%= @donation.amount.format(:html) %>
        </td>
    </tr>
    <tr>
        <td><!--%= submit_tag 'Continue' %--></td>
        <td></td>
    </tr>
    <% end -%>
    <tr>
        <td>
          <form action="https://www.sandbox.paypal.com/cgi-bin/webscr" id="payment-form" method="post">
            <input id="cancel_return" name="cancel_return" type="hidden" value="http://www.savetogether.org/"/>
            <input id="bn" name="bn" type="hidden" value="ActiveMerchant"/>
            <input id="redirect_cmd" name="redirect_cmd" type="hidden" value="_cart"/>
            <input id="cmd" name="cmd" type="hidden" value="_cart"/>
            <input type="hidden" name="upload" value="1">
            <input id="notify_url" name="notify_url" type="hidden" value="<%= url_for(:only_path => false, :action => 'notify') %>"/>
            <input id="charset" name="charset" type="hidden" value="utf-8"/>
            <input id="return" name="return" type="hidden" value="<%= url_for(:only_path => false, :action => 'create') %>"/>

        <% @donation.donation_line_items.each_with_index do |dli, index| -%>
            <input type="hidden" name="item_number_<%= index + 1 %>" value="<%= dli.account.id %>"/>
            <input type="hidden" name="item_name_<%= index + 1 %>" value="<%= dli.description %>"/>
            <input type="hidden" name="amount_<%= index + 1 %>" value="<%= dli.amount %>"/>
        <% end -%>

            <input id="tax" name="tax" type="hidden" value="0.00"/>
            <input id="invoice" name="invoice" type="hidden" value="<%= @donation.id %>"/>
            <input id="business" name="business" type="hidden" value="tom@savetogether.org"/>
            <input id="address_override" name="address_override" type="hidden" value="0"/>
            <input id="shipping" name="shipping" type="hidden" value="0.00"/>
            <input id="no_note" name="no_note" type="hidden" value="1"/>
            <input id="no_shipping" name="no_shipping" type="hidden" value="1"/>
            <input id="currency_code" name="currency_code" type="hidden" value="USD"/>

            <input name="commit" type="submit" value="Donate"/>
          </form>
            <% payment_service_for @donation.id, PAYPAL_ACCOUNT,
                              :amount => @donation.amount,
                              :currency => 'USD',
                              :service => :paypal,
                              :html => { :id => 'payment-form' } do |service| %>
                   <% service.invoice @donation.id %>
                   <% service.shipping '0.00' %>
                   <% service.tax '0.00' %>
               <% @donation.donation_line_items.each_with_index do |dli, index| -%>
                   <input type="hidden" name="item_number_<%= index %>" value="<%= dli.account.id %>"/>
                   <input type="hidden" name="item_name_<%= index %>" value="<%= dli.description %>"/>
                   <input type="hidden" name="amount_<%= index %>" value="<%= dli.amount %>"/>
               <% end -%>
                   <% service.notify_url url_for(:only_path => false, :action => 'notify') %>
                   <% service.return_url url_for(:only_path => false, :action => 'done') %>
                   <% service.cancel_return_url 'http://www.savetogether.org/' %>
                   <% service.redirect_cmd '_cart' %>
                   <!--%= submit_tag "Donate" %-->
             <% end %>
        </td>
    </tr>
</table>

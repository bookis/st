<table width="100%">
  <form action="https://www.sandbox.paypal.com/cgi-bin/webscr" id="payment-form" method="post">
    <input id="cancel_return" name="cancel_return" type="hidden" value="http://www.savetogether.org/"/>
    <input id="bn" name="bn" type="hidden" value="ActiveMerchant"/>
    <input id="redirect_cmd" name="redirect_cmd" type="hidden" value="_cart"/>
    <input id="cmd" name="cmd" type="hidden" value="_cart"/>
    <input type="hidden" name="upload" value="1">
    <input id="notify_url" name="notify_url" type="hidden" value="<%= url_for(:only_path => false, :action => 'notify') %>"/>
    <input id="charset" name="charset" type="hidden" value="utf-8"/>
    <input id="return" name="return" type="hidden" value="<%= url_for(:only_path => false, :action => 'create') %>"/>
    <tr>
        <td align="left" width="25%">
            <%= donation_line_item.description %>
        </td>
        <td align="left">
            <%= dli_form.text_field :amount, :size => 7 %>
            <%= dli_form.hidden_field :account_id %>
            <%= dli_form.hidden_field :description %>
        </td>
    </tr>
    <% @donation.donation_line_items.each_with_index do |dli, index| -%>
        <input type="hidden" name="item_number_<%= index + 1 %>" value="<%= dli.account.id %>"/>
        <input type="hidden" name="item_name_<%= index + 1 %>" value="<%= dli.description %>"/>
        <input type="hidden" name="amount_<%= index + 1 %>" value="<%= dli.amount %>"/>
    <% end -%>

    <input id="tax" name="tax" type="hidden" value="0.00"/>
    <input id="invoice" name="invoice" type="hidden" value="<%= @donation.id %>"/>
    <input id="business" name="business" type="hidden" value="tom@savetogether.org"/>
    <input id="address_override" name="address_override" type="hidden" value="0"/>
    <input id="shipping" name="shipping" type="hidden" value="0.00"/>
    <input id="no_note" name="no_note" type="hidden" value="1"/>
    <input id="no_shipping" name="no_shipping" type="hidden" value="1"/>
    <input id="currency_code" name="currency_code" type="hidden" value="USD"/>

    <input name="commit" type="submit" value="Donate"/>
  </form>
            <% payment_service_for @donation.id, PAYPAL_ACCOUNT,
                              :amount => @donation.amount,
                              :currency => 'USD',
                              :service => :paypal,
                              :html => { :id => 'payment-form' } do |service| %>
                   <% service.invoice @donation.id %>
                   <% service.shipping '0.00' %>
                   <% service.tax '0.00' %>
               <% @donation.donation_line_items.each_with_index do |dli, index| -%>
                   <input type="hidden" name="item_number_<%= index %>" value="<%= dli.account.id %>"/>
                   <input type="hidden" name="item_name_<%= index %>" value="<%= dli.description %>"/>
                   <input type="hidden" name="amount_<%= index %>" value="<%= dli.amount %>"/>
               <% end -%>
                   <% service.notify_url url_for(:only_path => false, :action => 'notify') %>
                   <% service.return_url url_for(:only_path => false, :action => 'done') %>
                   <% service.cancel_return_url 'http://www.savetogether.org/' %>
                   <% service.redirect_cmd '_cart' %>
                   <!--%= submit_tag "Donate" %-->
             <% end %>
</table>
<table width="100%">
  <% form_for @donation, :url => { :action => :create } do |f| %>
        <%= f.error_messages %>
        <%= f.hidden_field :user_id %>
        <%= f.hidden_field :saver_id %>
        <%= hidden_field_tag(:saver_id, @saver_id) %>
    <div id="donation_line_items">
        <div class="donation_line_item">

<% @donation.donation_line_items.each_with_index do |donation_line_item, index| -%>
            <p>
    <% fields_for "donation[donation_line_item_attributes][#{index}]", donation_line_item do |dli_form| -%>
    <tr>
        <td align="left" width="25%">
            <%= donation_line_item.description %>
        </td>
        <td align="left">
            <%= dli_form.text_field :amount, :size => 7 %>
            <%= dli_form.hidden_field :account_id %>
            <%= dli_form.hidden_field :description %>
        </td>
    </tr>
    <% end -%>
            </p>
<% end -%>
        </div>
    </div>
    <tr>
        <td align="left" width="25%">Send Notifications To
        </td>
        <td align="left"><%= f.text_field :notification_email %>
        </td>
    </tr>
    <tr>
        <td align="left" width="25%">Confirm Notification Email
        </td>
        <td align="left"><%= f.text_field :notification_email_confirmation %>
        </td>
    </tr>
    <tr>
        <td>
        </td>
        <td><%= f.submit "Continue" %>
        </td>
    </tr>
  <% end %>
</table>
